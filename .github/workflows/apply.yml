name: Terraform Apply

on:
 workflow_dispatch:
   inputs:
     choice:
      description: "Confirm to apply infastructure"
      required: true 
      type: string 
      default: ""

env:
 ECR_REPO: 678536383905.dkr.ecr.eu-west-2.amazonaws.com/ecs
 IMAGE_TAG: ${{ github.sha }}
 TF_VAR_image_tag: ${{ github.sha }}

jobs:
  build:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    permissions:
     id-token: write
     contents: read

    steps: 
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Configure AWS Credentials 
      uses: aws-actions/configure-aws-credentials@v4
      with:
       role-to-assume: ${{ secrets.AWS_GITHUB_ACTIONS_ROLE }}
       aws-region: eu-west-2

    - name: Setup Terraform 
      uses: hashicorp/setup-terraform@v3

    - name: Terraform Apply
      run: terraform apply --auto-approve
